{% extends 'base.html' %}

{% load static %}
{% block style %}
<style>
	body {
		color: white;
	}
	.own-message {
		background-color: #343435;
		text-align: right;
	}
	.other-message {
		background-color: #6601FE;
		text-align: left;
	}
	a {
		text-decoration: none;
	}
</style>
{% endblock %}

{% block content %}

<div class="container pt-3">

	<div class="row">
		<!-- friend chat -->
		<div class="col-md-3 col-lg-2 content-friend px-4 py-4 mx-1 mt-2" style="height: 90vh;">
			<div class="profile-main-text text-center mb-3">Chat</div>
			<!-- friend chat -->
			<div class="chat-h-body h-75">
				<ui class="chat-contacts">
					{% if rooms %}
						{% for loop_room in rooms %}
							<a onclick="swapApp('/chat/{{ loop_room.slug }}')">
								<li class="chat-box {% if room.slug == loop_room.slug %}active{% endif %}">
									<div class="d-flex bd-highligh align-items-center profile-content-text py-1">
										<div class="chat-image me-2">
											<img src="{% if loop_room.user1 == request.user %}{{ loop_room.user2.profile_image.url }}{% else %}{{ loop_room.user1.profile_image.url }}{% endif %}" class="rounded-circle user_img">
											{% if loop_room.user1 == request.user and loop_room.user2.active %}
												<span class="online_icon"></span>
											{% elif loop_room.user2 == request.user and loop_room.user1.active %}
												<span class="online_icon"></span>
											{% else %}
												<span class="online_icon offline"></span>
											{% endif %}
										</div>
										<span>{% if loop_room.user1 == request.user %}{{loop_room.user2.username}}{% else %}{{loop_room.user1.username}}{%endif%}</span><br>
									</div>
								</li>
							</a>
						{% endfor %}
					{% endif %}
				</ui>
			</div>
		</div>

		<!-- main -->
		<div class="col-md-8 col-lg-9 content-friend px-4 py-4 mx-1 mt-2 pb-5" style="height: 90vh;">
			<!-- chat header -->
			<div class="d-flex">
				{% if room.user1 == request.user %}
					<div class="profile-main-text me-auto"> {{ room.user2.username }} </div>
				{% elif room.user2 == request.user %}
					<div class="profile-main-text me-auto"> {{ room.user1.username }} </div>
				{% endif %}
				<button id="invite" class="btn btn-light btn-sm me-2" style=" font-size: 0.7rem;">
					<i class="bi bi-joystick"></i> invite
				</button>
				<a onclick="swapApp('/users/{{ friend.username }}/')">
					<button class="btn btn-light btn-sm me-2" style=" font-size: 0.7rem;">
						<i class="bi bi-person-fill"></i> profile
					</button>
				</a>
				<a onclick="swapApp('/users/block/{{ friend.username }}/')">
					<button class="btn btn-light btn-sm me-2" style=" font-size: 0.7rem; color: red">
						<i class="bi bi-ban"></i> Block
					</button>
				</a>
			</div>

			<!-- message -->
			<div class="p-4 chat-h-body h-80" style="color: #ececec; height: 95%;" id="id_chat_item_container">

				{% for message in messages %}
					<!-- friend -->
					{% if message.user.username != request.user.username %}
						<div class="d-flex justify-content-start mb-4">
							<div class="chat-image">
								<img src="{{ message.user.profile_image.url }}" class="rounded-circle user_img">
							</div>
							<div class="d-flex flex-column ps-2">
								<span>
									{% if message.is_link %}
										<a onclick="playGame('{{message.content}}')" style="color: lightblue; cursor: pointer">{{ message.content }}</a>
									{% else %}
										<a>{{ message.content }}</a>
									{% endif %}
								</span>
								<span class="profile-label-text">
									{{ message.create_on|date:"N d, H:i" }}
								</span>
							</div>
						</div>
					<!-- user -->
					{% else %}
						<div class="d-flex justify-content-end mb-4">
							<div class="d-flex flex-column pe-2">
								<span>
									{% if message.is_link %}
										<a onclick="playGame('{{message.content}}')" style="color: lightblue; cursor: pointer">{{ message.content }}</a>
									{% else %}
										<a>{{ message.content }}</a>
									{% endif %}
								</span>
								<span class="profile-label-text" style="text-align: end;">
									{{ message.create_on|date:"N d, H:i" }}
								</span>
							</div>
							<div class="chat-image">
								<img src="{{ request.user.profile_image.url }}" class="rounded-circle user_img">
							</div>
						</div>
					{% endif %}
				{% endfor %}
				
			</div>

			<!-- text box -->
			<div class="text-center">
				<input class="input-box" type="text" placeholder="Type your message" style=" background-color: #c4c4c4;" id="id_message_send_input">
				<button class="btn btn-dark rounded" id="id_message_send_button">Send</button>
			</div>

		</div>

	</div>

</div>
{% endblock %}

{% block body-script %}
<script>
	const roomSlug = "{{ room.slug }}";
	const roomName = "{{ room.name }}";
	const username = "{{ request.user.username }}"
	const my_img = "{{ request.user.profile_image.url }}"
	const friend_img = "{{ friend.profile_image.url }}"
	const friend_username = "{{ friend.username }}"

	chatSocket = new WebSocket("wss://" + window.location.host + "/ws/chat/" + roomSlug + "/");
	chatSocket.onopen = function (e) {
		console.log("chat socket connect to " + roomSlug);
	};
	chatSocket.onclose = function (e) {
		console.log("chat socket disconnect from " + roomSlug);
	};
	document.querySelector("#id_message_send_input").focus();
	document.querySelector("#id_message_send_input").onkeyup = function (e) {
		if (e.keyCode == 13) {
			document.querySelector("#id_message_send_button").click();
		}
	};
	document.querySelector("#id_message_send_button").onclick = function (e) {
		var messageInput = document.querySelector(
			"#id_message_send_input"
		).value;
		if (document.querySelector("#id_message_send_input").value == "")
			return;
		chatSocket.send(JSON.stringify({ message: messageInput, username: "{{request.user.username}}", room_name: roomName, is_link: false}));
		document.querySelector("#id_message_send_input").value = "";
	};
	chatSocket.onmessage = function (e) {
		const data = JSON.parse(e.data);

		var div_head = document.createElement("div");
		
		var img = document.createElement("img");
		var div_image = document.createElement("div");
		div_image.className = "chat-image";
		img.className = "rounded-circle user_img";
		div_image.appendChild(img);
		
		var div = document.createElement("div");
		var span_text = document.createElement("span");
		var a = document.createElement("a");
		if (data.is_link) {
			a.style = "color: lightblue; cursor: pointer";
			a.onclick = function() {
				playGame(data.message);
			};
		}
		a.appendChild(document.createTextNode(data.message));
		span_text.appendChild(a);
		var span_img = document.createElement("span");
		span_img.className = "profile-label-text";
		span_img.appendChild(document.createTextNode(data.time));
		div.appendChild(span_text);
		div.appendChild(span_img);
		
		if (data.username === username) {
			img.setAttribute("src", my_img);
			div_head.className = "d-flex justify-content-end mb-4";
			div.className = "d-flex flex-column pe-2";
			div_head.appendChild(div);
			div_head.appendChild(div_image);
		} else {
			img.setAttribute("src", friend_img);
			div_head.className = "d-flex justify-content-start mb-4";
			div.className = "d-flex flex-column ps-2";
			div_head.appendChild(div_image);
			div_head.appendChild(div);
		}

		document.querySelector("#id_message_send_input").value = "";
		document.querySelector("#id_chat_item_container").appendChild(div_head);
	};

	document.getElementById("invite").addEventListener("click", invite_message);
	function invite_message() {
		const formData = new FormData();
		formData.append('username', friend_username);

		fetch('/chat/invite/', {
			method: 'POST',
			headers: {
				'X-CSRFToken': getCookie('csrftoken')  // Include the CSRF token for security
			},
			body: formData
		})
		.then(response => {
			if (!response.ok) {
				throw new Error('Network response was not ok');
			}
			return response.json();
		})
		.then(data => {
			console.log('Room Code:', data.room_code);
			chatSocket.send(JSON.stringify({ message: data.room_code, username: "{{ request.user.username }}", room_name: roomName, is_link: true }));
		})
		.catch(error => {
			console.error('Error fetching invite:', error);
		});
	}
</script>
{% endblock %}