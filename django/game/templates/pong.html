{% extends 'base.html' %}
{% load static %}

{% load static %}

{% block head %}
	<link rel="stylesheet" href="{% static 'css/pong.css' %}">
{% endblock %}

{% block style %}
<style>
	body {
		color: white;
	}
	.own-message {
		background-color: #343435;
		text-align: right;
	}
	.other-message {
		background-color: #6601FE;
		text-align: left;
	}
	canvas {
		border: 1px solid black;
		display: block;
		margin: auto;
	}
</style>
{% endblock %}

{% block content %}

<div class="justify-content-center popup-menu" id="popUpEdit">
	<div class="wrapper justify-content-center" style="margin-top: 21vh;">
		<div class="d-flex row content-solid card-main mx-2" style="width: 350px">
			<div id="winner" class="card-topic"></div>
			<a>
				<button id="doneBtn" type="button" class="btn btn-light mt" style="width: 120px; font-size: 1rem;">
					Done
				</button>
			</a>
		</div>

	</div>
</div>

<div class="justify-content-center popup-menu" id="popUp">
	<div class="wrapper justify-content-center" style="margin-top: 30vh; margin-left: 100px;">
		<div class="d-flex row content-solid card-main mx-2 pt-5" style="width:  30%;">
			<h1 id="popUpStatus"></h1>
			<div class="wrapper justify-content-center">
				<h4 id="player1ScorePopUp">0</h4>
				<h4> : </h4>
				<h4 id="player2ScorePopUp">0</h4>
			</div>
			<a onclick="swapApp('/game/')" onclick="donePopUp();">
				<button type="button" class="btn btn-light mt-3" style="width: 35%; font-size: 1rem;">
					Done
				</button>
			</a>
		</div>
		
	</div>
</div>

<div id="gameStatus" style="z-index: 2;">

	<!-- Waiting -->
	
	<div style="display: block;" id="waiting-content">
		<div class="wrapper justify-content-center">
			<div class="content-solid rounded mt-4 px-2 py-2 wrapper justify-content-center" style="width: 60vw;">
				<div>
					<small> Game Pin :</small>
					<h1 class="display-2 fw-bolder">{{ room_code }}</h1>
				</div>
			</div>
		</div>
		<div class="wrapper justify-content-center row" style="text-align: center;">
			<div style="width: 30vw;">
				<div class="wrapper justify-content-between" style="margin-top: 25vh; margin-bottom: 10vh;">
					<h2 class="wrapper">
						<div class="chat-image mx-2">
							<img src="{% if request.user.is_authenticated %}{{ profile_image }}{% else %}/media/profile_pics/default_profile_image.png{% endif %}" class="rounded-circle user_img">
						</div>
						{{ username }}
					</h2>
					<h1 class="fw-bolder">VS</h1>
					<h2 class="wrapper">
						<div class="chat-image mx-2">
							<img src="/media/profile_pics/default_profile_image.png" class="rounded-circle user_img">
						</div>
						<div>???</div>
					</h2>
				</div>
				<p class="mt-2">Waiting . . .</p>
				<a style="text-decoration: none; color: black;" onclick="swapApp('/game/')">
					<button type="button" class="btn btn-light card-x-btn mb-4">
						cancel
					</button>
				</a>
			</div>
		</div>
	</div>



	<!-- GAME -->

	<div style="display: none;" id="game-content">
		<div class="wrapper justify-content-center">
			<div class="content-solid rounded mt-4 px-3 py-2 wrapper justify-content-around align-items-center" style="width: 60vw;">
				<div>
					<small> Game Pin :</small>
					<h1 class="display-2 fw-bolder">{{ room_code }}</h1>
				</div>
				<div class="wrapper align-items-center">
					<h3 id="player1Top">{{ username }}</h3>
					<h2 class="fw-bolde mx-3">VS</h2>
					<h3 id="player2Top">???</h3>
				</div>
	
			</div>
		</div>
		<div class="wrapper justify-content-center" style="width: 100%">
			<div class="col-2 p-3 mt-4 justify-content-center text-center">
				<div class="user-image">
					<img id="img_player1" src="https://img.freepik.com/free-psd/portrait-teenage-boy-white-hoodie-gray-background_1142-60290.jpg?w=1380&t=st=1714908991~exp=1714909591~hmac=4ec5e60aa745cb307b99286ad267b22f9caf2aa29bc752612cc5d53402e9476c" class="rounded-circle user_img">
				</div>
				<h4 id="player1">{{ username }}</h4>
				<h1 class="mt-5" id="player1Score">0</h1>
			</div>
			<div class="justify-content-center wrapper" style="width: 100%;">
				<div class="col-12 p-3 profile-solid mt-4 mx-3 rounded justify-content-center">
					<div class="game-panel">
						<canvas id="pongCanvas" width="800" height="400"></canvas>
					</div>
					<div class="my-2">
						<div class="progress" style="border: 2px solid #b3b3b3;">
							<div ></div>
							<div id="player1Scale" class="progress-bar-striped progress-bar-animated progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
							<div id="blankScale" class="progress-bar bg-dark" role="progressbar" style="width: 100%" aria-valuemin="0" aria-valuemax="100"></div>
							<div id="player2Scale" class="progress-bar-striped progress-bar-animated progress-bar bg-danger" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-2 p-3 mt-4 justify-content-center text-center">
				<div class="user-image">
					<img id="img_player2" src="https://img.freepik.com/free-psd/portrait-teenage-boy-white-hoodie-gray-background_1142-60290.jpg?w=1380&t=st=1714908991~exp=1714909591~hmac=4ec5e60aa745cb307b99286ad267b22f9caf2aa29bc752612cc5d53402e9476c" class="rounded-circle user_img">
				</div>
				<h4 id="player2">???</h4>
				<h1 class="mt-5" id="player2Score">0</h1>
			</div>
		</div>
	</div>


</div>
{% endblock %}

{% block body-script %}
<script>
	const roomCode = "{{ room_code }}";
	const username = "{{ username }}";
	const profile_image = "{{ profile_image }}"
	const playerNo = "{{ playerNo }}";
	const gameState = "{{ game_state }}"
	const isJoin = "{{ isJoin }}"
	let player1name;
	let player2name;
	let winner;
	
	// game variable
	let gameLoopIdRps;

	const canvas = document.getElementById("pongCanvas");
	const context = canvas.getContext("2d");

	// Ball properties
	let ballX = canvas.width / 2;
	let ballY = canvas.height / 2;
	let ballSpeedX = 5;
	let ballSpeedY = 5;
	const ballSize = 10;

	// Paddle properties
	const paddleWidth = 10;
	const paddleHeight = 100;
	let paddle1Y = 150;
	let paddle2Y = 150;
	const paddleSpeed = 10;

	// Scores
	let player1Score = 0;
	let player2Score = 0;
	const winningScore = 10;

	// Keyboard controls
	let upPressed = false;
	let downPressed = false;
	let wPressed = false;
	let sPressed = false;

	// Game over state
	let gameOver = false;

	document.addEventListener("keydown", keyDownHandler);
	document.addEventListener("keyup", keyUpHandler);

	pongSocket = new WebSocket("wss://" + window.location.host + "/ws/game/" + roomCode + "/" + username + "/");
	pongSocket.onopen = function (e) {
		console.log("pong socket connect to " + roomCode + " you are player " + playerNo);
		if (playerNo == 1) {
			if (isJoin) {
				document.getElementById("waiting-content").style.display = 'none';
				document.getElementById("game-content").style.display = 'block';
			}
			player1name = username;
			document.getElementById("player1Top").innerHTML = username;
			document.getElementById("player1").innerHTML = username;
			document.getElementById("img_player1").src = profile_image;
		}
		else if (playerNo == 2) {
			document.getElementById("waiting-content").style.display = 'none';
			document.getElementById("game-content").style.display = 'block';

			player2name = username;
			document.getElementById("player2Top").innerHTML = username;
			document.getElementById("player2").innerHTML = username;
			document.getElementById("img_player2").src = profile_image;
		}
		pongSocket.send(JSON.stringify({ball_x: ballX, ball_y: ballY, paddle1_y: paddle1Y, paddle2_y: paddle2Y, player1score: player1Score, player2score: player2Score, start_point: true }));
	};

	pongSocket.onclose = function (e) {
		console.log("pong socket disconnect");
		cleanupGameRps();
	};

	pongSocket.onmessage = function (e) {
		const data = JSON.parse(e.data);
		if (!data.exit && data.username != username) {
			if (playerNo == 1) {
				player2name = data.username;
				document.getElementById("player2Top").innerHTML = data.username;
				document.getElementById("player2").innerHTML = data.username;
				document.getElementById("img_player2").src = data.profile_image;
			}
			else if (playerNo == 2) {
				player1name = data.username;
				document.getElementById("player1Top").innerHTML = data.username;
				document.getElementById("player1").innerHTML = data.username;
				document.getElementById("img_player1").src = data.profile_image;
			}
			if (data.start_point){
				document.getElementById("waiting-content").style.display = 'none';
				document.getElementById("game-content").style.display = 'block';
				pongSocket.send(JSON.stringify({ball_x: ballX, ball_y: ballY, paddle1_y: 300, paddle2_y: 300, player1score: player1Score, player2score: player2Score, start_point: false }));
			}
		}
		player1Score = data.player1score;
		player2Score = data.player2score;
		ballX = data.ball_x;
		ballY = data.ball_y;
		paddle1Y = data.paddle1_y;
		paddle2Y = data.paddle2_y;
		updateScore();
	};

	// pong game javascript

	function keyDownHandler(event) {
        if (event.key === "ArrowUp" || event.key === "w") {
			if (playerNo == 1)
				pongSocket.send(JSON.stringify({action: 'move_paddle', type: 'keydown',  direction: 'up', player: 1}));
			else if (playerNo == 2)
				pongSocket.send(JSON.stringify({action: 'move_paddle', type: 'keydown',  direction: 'up', player: 2}));
            upPressed = true;
        } else if (event.key === "ArrowDown" || event.key === "s") {
			if (playerNo == 1)
				pongSocket.send(JSON.stringify({action: 'move_paddle', type: 'keydown', direction: 'down', player: 1}));
			else if (playerNo == 2)
				pongSocket.send(JSON.stringify({action: 'move_paddle', type: 'keydown', direction: 'down', player: 2}));
            downPressed = true;
        }
    }
	
    function keyUpHandler(event) {
		if (event.key === "ArrowUp" || event.key === "w") {
			if (playerNo == 1)
				pongSocket.send(JSON.stringify({action: 'move_paddle', type: 'keyup', direction: 'up', player: 1}));
			else if (playerNo == 2)
				pongSocket.send(JSON.stringify({action: 'move_paddle', type: 'keyup', direction: 'up', player: 2}));
            upPressed = false;
        } else if (event.key === "ArrowDown" || event.key === "s") {
			if (playerNo == 1)
				pongSocket.send(JSON.stringify({action: 'move_paddle', type: 'keyup', direction: 'down', player: 1}));
			else if (playerNo == 2)
				pongSocket.send(JSON.stringify({action: 'move_paddle', type: 'keyup', direction: 'down', player: 2}));
            downPressed = false;
        }
    }

	function updateScore() {
		document.getElementById("player1Score").innerHTML = player1Score;
		document.getElementById("player1ScorePopUp").innerHTML = player1Score;
		document.getElementById("player2Score").innerHTML = player2Score;
		document.getElementById("player2ScorePopUp").innerHTML = player2Score;
		
		document.getElementById("player1Scale").style.width = player1Score * 5 + "%";
		document.getElementById("blankScale").style.width = (20 - player1Score - player2Score) * 5 + "%";
		document.getElementById("player2Scale").style.width = player2Score * 5 + "%";
		checkWinLose();
	}

	function checkWinLose() {
		if (player1Score >= 10) {
			winner = player1name;
			document.getElementById("winner").innerHTML = 'The winner is ' + winner;
			showEdit();
		}
		else if (player2Score >= 10) {
			winner = player2name;
			document.getElementById("winner").innerHTML = 'The winner is ' + winner;
			showEdit();
		}
	}

	function draw() {
        // Clear canvas
        context.clearRect(0, 0, canvas.width, canvas.height);

        // Draw paddles
        context.fillStyle = "white";
        context.fillRect(0, paddle1Y, paddleWidth, paddleHeight);
        context.fillRect(canvas.width - paddleWidth, paddle2Y, paddleWidth, paddleHeight);

        // Draw ball
        context.beginPath();
        context.arc(ballX, ballY, ballSize, 0, Math.PI * 2);
        context.fillStyle = "white";
        context.fill();
        context.closePath();

        // game over text
		if (gameOver) {
            context.fillStyle = "white";
            context.font = "30px Arial";
            context.fillText("GAME OVER", canvas.width / 2 - 80, canvas.height / 2);
            context.fillText("Press Spacebar to Restart", canvas.width / 2 - 170, canvas.height / 2 + 40);
        }
    }

	function gameLoopRps() {
		draw();
        if (gameOver)
            return;
        gameLoopIdRps = requestAnimationFrame(gameLoopRps);	
	}

	window.cleanupGameRps = function() {
        cancelAnimationFrame(gameLoopIdRps);
        document.removeEventListener("keydown", keyDownHandler);
        document.removeEventListener("keyup", keyUpHandler);
        console.log("Cleaned up game script");
    };

	gameLoopRps();

	// record game
	function recordGame() {
		if (winner === username) {
			console.log('match recording');
			const formData = new FormData();
			formData.append('gameType', '1v1');
			formData.append('player1name', player1name);
			formData.append('player2name', player2name);
			formData.append('winner', winner);
			formData.append('player1score', player1Score);
			formData.append('player2score', player2Score);

			fetch('/game/match_record/', {
			 	method: 'POST',
			 	body: formData,
			 	headers: {
			 		'X-CSRFToken': getCookie('csrftoken')
				}
			})
			.then(response => response.json())
			.then(data => {
				console.log('Response from server:', data);
			})
			.catch(error => {
				console.error('Error:', error);
			});
		}
		swapApp('/game/');
	}
	function showEdit() {
		document.getElementById("popUpEdit").style.display = 'block';
	}
	function doneEdit() {
		recordGame();
		document.getElementById("popUpEdit").style.display = 'none';
	}
	document.getElementById("doneBtn").addEventListener("click", doneEdit);

</script>
{% endblock %}